<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
  <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
    <!DOCTYPE html>
    <html lang="en">

    <head>
      <title>Soon Service</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <style type="text/css">
        @charset "UTF-8";

        @font-face {
          font-family: 'GeekbleMalang2WOFF2';
          src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/GeekbleMalang2WOFF2.woff2') format('woff2');
          font-weight: normal;
          font-style: normal;
        }

        /* ì œëª© í°íŠ¸ - gë§ˆì¼“ì‚°ìŠ¤ë¯¸ë””ì—„ */
        @font-face {
          font-family: 'GmarketSansMedium';
          src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
          font-weight: normal;
          font-style: normal;
        }

        /* ë‚´ìš© í°íŠ¸ - í”„ë¦¬í…ë‹¤ë“œ */
        @font-face {
          font-family: 'Pretendard-Regular';
          src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
          font-weight: 400;
          font-style: normal;
        }

        /* ì›¹ì§„ì—ì„œ ì‚¬ìš©í•˜ê¸° */
        @font-face {
          font-family: 'Chosunilbo_myungjo';
          src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/Chosunilbo_myungjo.woff') format('woff');
          font-weight: normal;
          font-style: normal;
        }

        body {
          font-family: 'Pretendard-Regular';
        }

        #headCon {
          padding-top: 10px;
          padding-bottom: 10px;
          padding-left: 20%;
          padding-right: 20%;
          font-family: 'GeekbleMalang2WOFF2';
        }

        #login,
        #wform {
          padding-top: 100px;
          padding-left: 20%;
          padding-right: 20%;
          paddig-bottom: 20%;
          justify-content: center;
        }

        #kakao-login-btn {
          display: flex;
          align-items: center;
          justify-content: center;

        }

        #headingOne,
        #headingTwo,
        #headingThree,
        .card-title {
          font-family: 'GmarketSansMedium';
        }

        #collapseOne,
        #collapseTwo,
        #collapseThree {
          font-family: 'Pretendard-Regular';
        }

        #view {
          padding-top: 90px;
          padding-left: 20%;
          padding-right: 20%;
          paddig-bottom: 20%;
          justify-content: center;
        }

        #CList {
          padding-top: 5px;
          justify-content: center;
        }

        #repleArea {
          display: flex;
          justify-content: space-around;
        }

        .reple {
          width: 85%;

        }

        #reIns {
          width: 10%;
        }

        #writer {
          padding-top: 10px;
          padding-left: 20%;
          padding-right: 20%;
          justify-content: center;
        }

        .good {
          background-color: #ffffff;
          color: rgb(0, 0, 0);
          height: 30px;
          border-color: #ffffff00;
        }
      </style>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

      <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

      <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.3.0/kakao.min.js"
        integrity="sha384-70k0rrouSYPWJt7q9rSTKpiTfX6USlMYjZUtr1Du+9o4cGvhPAWxngdtVZDdErlh"
        crossorigin="anonymous"></script>
      <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

      <script type="text/javascript">
        $(document).ready(() => {
          // HTML êµ¬ì¡°ê°€ ë‹¤ ë¡œë”©ì´ ëœ í›„ì— loadList()ì‹¤í–‰
          loadList()
        });

        const loadList = () => {
          // BoardControllerì—ì„œ ê²Œì‹œê¸€ ì „ì²´ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ê¸°ëŠ¥
          $.ajax({
            url: "boardSelectList.do",
            dataType: "json",
            success: makeView, //callbackí•¨ìˆ˜
            error: () => { alert("error"); }
          });
        }
        // ì„±ê³µ ì‹œ ì‹¤í–‰í•  makeView í•¨ìˆ˜ -> jspì— ë°ì´í„°ë¥¼ ë¿Œë ¤ì£¼ëŠ” í•¨ìˆ˜
		const makeView = (data) => {
		    console.log(data);
		
		    // ê²Œì‹œê¸€ì„ í‘œì‹œí•  ë¶€ëª¨ ìš”ì†Œ
		    const $view = $('#view');
		
		    // ë¹„ë™ê¸° ì‘ì—…ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í•¨ìˆ˜
		    const processPost=(index)=> {
		        if (index < data.length) {
		            const obj = data[index];
		
		            $.ajax({
		                url: "repleSelectList.do",
		                data: { "idx": obj.idx },
		                dataType: "json",
		                success: (data2) => {
		                	console.log('ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´');
		                    // ê²Œì‹œê¸€ ìš”ì†Œë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
		                    const $post = $("<div class='CList'></div>");
		                    const $card = $("<div class='card'></div>");
		                    const $cardBody = $("<div class='card-body'></div>");
		
		                    // ê²Œì‹œê¸€ ë‚´ìš© ì„¤ì •
		                    $cardBody.append("<h5 class='card-title'>" + obj.btitle + "</h5>");
		                    $cardBody.append("<span id='c" + obj.idx + "' style='display:none;'></span>");
		                    $cardBody.append("<h6 class='card-subtitle mb-2 text-muted'>" + obj.nick + "</h6>");
		                    $cardBody.append("<p class='card-text'>" + obj.bcontent + "</p><hr>");
		                    $cardBody.append("<p class='card-text' style='font-size: smaller;'>" + obj.bdate + "</p>");
		                    $cardBody.append("<p class='card-text'><a href='javascript:goGood(" + obj.idx + ")'><button type='button' class='good'>ğŸ’“</button></a><span id='goodCount" + obj.idx + "'>" + obj.bgood + "</span></p>");
		
		                    // ëŒ“ê¸€ ì¶œë ¥
		                    $.each(data2, (index, obj2)=>{
		                   	 	$cardBody.append("<p class='card-text' style='font-size: smaller;'>" + obj2.rcontent + "</p><div id='newreple"+ obj.idx + "'></div>");
		                    });
		                    // ëŒ“ê¸€ ì…ë ¥ í¼
		                    $cardBody.append("<div id='repleArea'><input type='text' id='reple" + obj.idx + "' name='reple' class='form-control'><button id='reIns' type='button' class='btn btn-primary btn-sm' onclick='repleInsert(" + obj.idx + ")'>ë“±ë¡</button></div>");
		
		                    // ê²Œì‹œê¸€ ìš”ì†Œë¥¼ í™”ë©´ì— ì¶”ê°€
		                    $card.append($cardBody);
		                    $post.append($card);
		                    $view.append($post);
		
		                    // ë‹¤ìŒ ê²Œì‹œê¸€ ì²˜ë¦¬
		                    processPost(index + 1);
		                },
		                error: () => { alert("error"); }
		            });
		        } else {
		            // ëª¨ë“  ê²Œì‹œê¸€ì„ ì²˜ë¦¬í•œ í›„ì— í•„ìš”í•œ ì‘ì—… ìˆ˜í–‰
		            goList();
		        }
		    }
		
		    // ì²« ë²ˆì§¸ ê²Œì‹œê¸€ë¶€í„° ì‹œì‘
		    processPost(0);
		};



        const goForm = () => {
          $("#writer").css("display", "none")
          $("#login").css("display", "none")
          $("#view").css("display", "none")
          $("#wform").css("display", "block")
        }

        const goList = () => {
          $("#writer").css("display", "block")
          $("#login").css("display", "none")
          $("#view").css("display", "block")
          $("#wform").css("display", "none")
        }

        const boardInsert = () => {
          $.ajax({
            url: "boardInsert.do",
            data: $("#form").serialize(),
            type: 'POST',
            success: loadList, // ìƒˆë¡œê³ ì¹¨
            error: () => { alert("error"); }
          });
        }
        //
        const goGood = (idx) => {
        	console.log(idx);
          $.ajax({
            url: "boardGood.do", /* ì–´ë””ë¡œ ë³´ë‚¼ì§€ */
            data: { "idx": idx }, /* ì–´ë–¤ ë°ì´í„°ë¥¼ ë³´ë‚¼ì§€ */
            dataType:"json",
            type: 'POST',
            success:(data)=>{            	
            		$("#goodCount"+idx).html(data.bcount); 
            	           	
            },
            error: () => { alert("error"); }
          });
          
        }
        
        const repleInsert=(idx)=>{
			console.log(idx);
			var rContent = $("#reple"+idx).val();
			console.log(rContent);
			$.ajax({
				url : "repleInsert.do",
				type:'POST',
				data: { "idx": idx,
						"rContent" : rContent },
				dataType:"json",
				success : (data)=>{
					console.log(data)
            		var con = "";					
            		con += "<p class='card-text' style='font-size: smaller;'>" + data[data.length-1].rcontent + "</p><div id='newreple"+ idx + "'></div>";
            		
            	console.log(con)
	            	$cardBody.append(con);            	
	            },
				error : ()=>{alert("error");}				
			});
		}


      </script>



    </head>

    <body>
      <!-- í—¤ë” -->
      <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid" id="headCon">
          <a class="navbar-brand" href="/">ìˆœì´</a>
          <ul class="nav nav-pills">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">íƒ€ì„ë¼ì¸</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">ë§ˆì´í˜ì´ì§€</a>
            </li>
          </ul>
        </div>
      </nav>
      <div id='writer'><input type='text' id='boardInsert' name='reple' class='form-control' placeholder="ë¬´ì—‡ì´ë“  ì ì–´ë³´ì„¸ìš”!"
          onclick='goForm()'></div>

      <!-- ì²« í™”ë©´ ë¡œê·¸ì¸ -->
      <div class="accordion" id="login" style="display:none">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
              aria-expanded="true" aria-controls="collapseOne">
              ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
            data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <ul>
                <li id="kakao-login-btn" onclick="kakaoLogin();">
                  <a href="javascript:void(0)">
                    <img src="https://k.kakaocdn.net/14/dn/btroDszwNrM/I6efHub1SN5KCJqLm1Ovx1/o.jpg" alt="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼">
                  </a>
                </li>
                <!-- ë¡œê·¸ì¸ ì‹œì‘ -->
                <script>
                  //ì¹´ì¹´ì˜¤ë¡œê·¸ì¸
                  const kakaoLogin = () => {
                    Kakao.Auth.login({
                      scope: 'profile_nickname, account_email',
                      success: () => {
                        Kakao.API.request({
                          url: '/v2/user/me',
                          success: (response) => {
                            console.log(response)
                            // Ajaxë¥¼ ì´ìš©í•´ postë°©ì‹ìœ¼ë¡œ ê°’ ë„˜ê¸°ê¸°                   
                            $.ajax({
                              type: 'POST',
                              url: 'EmailCheck',
                              data: { email: response.kakao_account.email },
                              datatype: "text",
                              success: (data) => {
                                if (data == 'false') {
                                  $.ajax({
                                    // ë¡œê·¸ì¸ ì‹œí‚¤ê¸°
                                    type: 'POST',
                                    url: 'LoginService',
                                    data: {
                                      nickName: response.properties.nickname,
                                    },
                                    success: (result) => {
                                      console.log(result);
                                      location.replace();
                                    },
                                    error: () => {
                                      location.replace();
                                    }
                                  })
                                } else {
                                  $.ajax({
                                    // ì¤‘ë³µì´ ì•„ë‹ˆë‹ˆê¹Œ íšŒì›ê°€ì… ì‹œí‚¤ê¸°
                                    type: 'POST',
                                    url: 'JoinService',
                                    data: {
                                      nickName: response.properties.nickname,
                                      email: response.kakao_account.email,
                                    },
                                    success: (result) => {
                                      console.log(result);
                                      location.replace();
                                    },
                                    error: (error) => {
                                      console.log(error);
                                      location.replace();
                                    }
                                  })
                                }
                              }
                            });
                          },
                          fail: (error) => {
                            console.log(error)
                          },
                        })
                      },
                      fail: (error) => {
                        console.log(error)
                      },
                    })
                  }
                </script>
                <!-- 
              âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸âœŒï¸
             -->



              </ul>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              ë©”ì¼ë¡œ ë¡œê·¸ì¸
            </button>
          </h2>
          <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
            data-bs-parent="#accordionExample">
            <div class="accordion-body">
              ë¡œê·¸ì¸ ë„£ê¸°
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingThree">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
              ë©”ì¼ë¡œ íšŒì›ê°€ì…
            </button>
          </h2>
          <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
            data-bs-parent="#accordionExample">
            <div class="accordion-body">
              íšŒì›ê°€ì… ë„£ê¸°
            </div>
          </div>
        </div>
      </div>

      <!-- ë¡œê·¸ì¸ í•˜ë©´ íƒ€ì„ë¼ì¸, ë§ˆì´í˜ì´ì§€ ì¤‘ ì„ íƒ (ê¸°ë³¸ì€ ìŠ¤ë ˆë“œ) -->

      <!-- íƒ€ì„ë¼ì¸ ëª©ë¡ -->
      <div id="view">

      </div>

      <!-- ê¸€ì“°ê¸° -->
      <div class="card-body" id="wform" style="display: none;">
        <form id="form" name="form" th:object="${board}">
          <div class='card'>
            <div class='card-body'>
              <input type="text" id="bTitle" name="bTitle" class="form-control card-title">
              <input type="text" id="nick" name="nick" class="form-control card-text">

              <textarea rows="7" cols="" id="bContent" name="bContent" class="form-control card-text"></textarea>

              <div class=card-text style="justify-content: center;">
                <button type="button" class="btn btn-success btn-sm" onclick='boardInsert()'>ë“±ë¡</button>
                <button type="button" class="btn btn-primary btn-sm" onclick='goList()'>ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
        </form>
      </div>



    </body>

    </html>